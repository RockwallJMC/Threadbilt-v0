#!/usr/bin/env bash
set -euo pipefail
echo "Scanning for Playwright and npm/Next dev processes..."
PATTERN="playwright|@playwright/test/cli\\.js test-server|playwright-mcp|npm run dev|next dev|next-server"
if command -v rg >/dev/null 2>&1; then
  MATCH="rg -n"
  MATCH_NOLN="rg --no-line-number"
else
  MATCH="grep -En"
  MATCH_NOLN="grep -E"
fi
ps -eo pid,cmd | eval ${MATCH} "\"${PATTERN}\"" || true
echo
echo "Listening on port 4000 (if permitted):"
if command -v ss >/dev/null 2>&1; then
  ss -lptn 'sport = :4000' || true
else
  echo "ss not available; skipping port check."
fi
PIDS=$(ps -eo pid=,cmd= | eval ${MATCH_NOLN} "\"${PATTERN}\"" | awk '{print $1}' | sort -u)
if [[ -z "${PIDS}" ]]; then
  echo "No matching processes found."
  exit 0
fi
echo
echo "Sending SIGTERM to PIDs:"
echo "${PIDS}"
kill -TERM ${PIDS}
echo "Done."
